<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allentown PLMS Breakdown</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Pinned Versions) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts (Pinned Stable Version) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <style>
        body { background-color: #f8fafc; }
        /* Custom scrollbar for table */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Destructure globals
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // --- INLINE ICONS ---
        const IconBase = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const BarChart2 = (props) => <IconBase {...props}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></IconBase>;
        const TableIcon = (props) => <IconBase {...props}><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const FileSpreadsheet = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconBase>;
        const Database = (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></IconBase>;
        const Package = (props) => <IconBase {...props}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></IconBase>;
        const Hash = (props) => <IconBase {...props}><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></IconBase>;

        const COLORS = {
            'Line A': { primary: 'bg-blue-600', secondary: 'bg-blue-100', text: 'text-blue-600', hex: '#2563eb' },
            'Line B': { primary: 'bg-emerald-600', secondary: 'bg-emerald-100', text: 'text-emerald-600', hex: '#059669' },
            'Line C': { primary: 'bg-orange-600', secondary: 'bg-orange-100', text: 'text-orange-600', hex: '#ea580c' },
            'Line D': { primary: 'bg-purple-600', secondary: 'bg-purple-100', text: 'text-purple-600', hex: '#7c3aed' },
        };

        const MONTH_COLORS = [
            '#2563eb', // Blue
            '#ea580c', // Orange
            '#059669', // Green
            '#7c3aed', // Purple
            '#db2777', // Pink
            '#ca8a04', // Yellow
            '#dc2626', // Red
            '#0891b2', // Cyan
            '#4f46e5', // Indigo
            '#be123c', // Rose
            '#16a34a', // Green
            '#d97706'  // Amber
        ];

        const SAMPLE_DATA = `Date\tStart Time\tLine\tSide\tEvent Code Number\tEvent Code Description\tDuration\tPackages\tOther Code\tOriginal Event Code\tOriginal Event Description\tInformation Events
11/07/2025\t06:00:00\tLine A\tLeft\t101\tJam at Infeed\t0:45:00\t500\t-\t101\tJam at Infeed\t-
\t08:30:00\tLine A\tRight\t204\tNo Material\t2:00:00\t0\tErr-01\t204\tNo Material\tSupplier Delay
\t09:15:00\tLine B\tLeft\t305\tMotor Overheat\t200\t1200\t-\t305\tMotor Overheat\tCheck temp
11/08/2025\t10:00:00\tLine C\t-\t404\tPackaging Error\t1:30:00\t450\t-\t404\tPackaging Error\t-
\t11:00:00\tLine D\tRight\t500\tConveyor Belt Snap\t300\t0\tCRIT\t500\tBelt Snap\tMaintenance called`;

        const App = () => {
            const [rawData, setRawData] = useState('');
            const [processedData, setProcessedData] = useState(() => {
                try {
                    const saved = localStorage.getItem('downtimeDB');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            });
            const [activeTab, setActiveTab] = useState('Line A');
            const [error, setError] = useState(null);
            const [successMsg, setSuccessMsg] = useState(null);

            // Filters
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [topFilter, setTopFilter] = useState('5'); 
            const [selectedMonth, setSelectedMonth] = useState(null); // New state for month filtering

            useEffect(() => {
                localStorage.setItem('downtimeDB', JSON.stringify(processedData));
            }, [processedData]);

            // Clear selected month when changing lines to avoid confusion
            useEffect(() => {
                setSelectedMonth(null);
            }, [activeTab]);

            const parseDurationToMinutes = (str) => {
                if (!str) return 0;
                const s = str.toString().toLowerCase().trim();
                
                if (s.includes(':')) {
                    const parts = s.split(':').map(p => parseFloat(p));
                    if (parts.some(p => isNaN(p))) return 0;
                    if (parts.length === 3) return parseFloat(((parts[0] * 60) + parts[1] + (parts[2] / 60)).toFixed(2));
                    if (parts.length === 2) return (parts[0] * 60) + parts[1];
                }
                const match = s.match(/(\d+(?:\.\d+)?)\s*(h|hr|hours?|m|min|minutes?|s|sec|seconds?)/);
                if (match) {
                    const val = parseFloat(match[1]);
                    const unit = match[2];
                    if (unit.startsWith('h')) return val * 60;
                    if (unit.startsWith('s')) return parseFloat((val / 60).toFixed(2));
                    return val;
                }
                if (s.includes('/') || s.includes('-')) return 0;
                const num = parseFloat(s);
                if (!isNaN(num) && isFinite(num)) return num;
                return 0;
            };

            const handleProcess = () => {
                try {
                    setError(null);
                    setSuccessMsg(null);
                    if (!rawData.trim()) {
                        setError("Please paste some data first.");
                        return;
                    }

                    const rows = rawData.trim().split('\n');
                    if (rows.length < 2) {
                        setError("Not enough data rows.");
                        return;
                    }

                    const headerRow = rows[0].toLowerCase().split('\t').map(h => h.trim());
                    const colMap = {
                        date: headerRow.findIndex(h => h === 'date' || h === 'date of occurrence'),
                        startTime: headerRow.findIndex(h => h.includes('start time') || h.includes('start')),
                        line: headerRow.findIndex(h => h.includes('line')),
                        side: headerRow.findIndex(h => h.includes('side')),
                        eventCode: headerRow.findIndex(h => h.includes('event code number') || h === 'event code' || h === 'code'),
                        reason: headerRow.findIndex(h => h.includes('event code description') || h.includes('description') || h.includes('reason')),
                        duration: headerRow.findIndex(h => h.includes('duration') || h.includes('minutes') || h.includes('downtime')),
                        packages: headerRow.findIndex(h => h.includes('packages') || h.includes('pack') || h.includes('qty')),
                        otherCode: headerRow.findIndex(h => h.includes('other code')),
                        origEventCode: headerRow.findIndex(h => h.includes('original event code')),
                        origEventDesc: headerRow.findIndex(h => h.includes('original event description')),
                        infoEvents: headerRow.findIndex(h => h.includes('information events') || h.includes('info'))
                    };

                    const dataRows = rows.slice(1);
                    const parsed = [];
                    let lastValidDate = null;

                    dataRows.forEach((row, index) => {
                        const cols = row.split('\t');
                        if (cols.length < 2) return;

                        let line = 'Unknown';
                        let duration = 0;
                        let reason = 'Unspecified';
                        let dateVal = '-'; 
                        let isoDate = '';
                        let originalDuration = '';
                        
                        let startTime = '';
                        let side = '';
                        let eventCode = '';
                        let packages = '';
                        let otherCode = '';
                        let origEventCode = '';
                        let origEventDesc = '';
                        let infoEvents = '';

                        if (colMap.date !== -1) {
                            const cellVal = cols[colMap.date]?.trim();
                            if (cellVal && (cellVal.includes('/') || cellVal.includes('-'))) {
                                lastValidDate = cellVal;
                            }
                        }
                        
                        if (lastValidDate) {
                            dateVal = lastValidDate;
                        } else if (colMap.startTime !== -1 && cols[colMap.startTime]) {
                            const st = cols[colMap.startTime].trim();
                            if (st.includes('/') || st.includes('-')) {
                                dateVal = st.split(' ')[0];
                            }
                        }

                        if (colMap.line !== -1 && cols[colMap.line]) {
                            line = cols[colMap.line]; 
                        } else {
                            const lineCol = cols.find(c => c.toLowerCase().includes('line'));
                            if (lineCol) line = lineCol;
                        }
                        const lLower = line.toLowerCase();
                        if (lLower.includes('line a')) line = 'Line A';
                        else if (lLower.includes('line b')) line = 'Line B';
                        else if (lLower.includes('line c')) line = 'Line C';
                        else if (lLower.includes('line d')) line = 'Line D';

                        if (colMap.duration !== -1 && cols[colMap.duration]) {
                            originalDuration = cols[colMap.duration];
                            duration = parseDurationToMinutes(originalDuration);
                        } else {
                            const durIdx = cols.findIndex(c => parseDurationToMinutes(c) > 0);
                            if (durIdx !== -1) {
                                originalDuration = cols[durIdx];
                                duration = parseDurationToMinutes(originalDuration);
                            }
                        }

                        if (colMap.reason !== -1 && cols[colMap.reason]) {
                            reason = cols[colMap.reason].trim();
                        } else {
                            const potentialReasons = cols.filter(c => {
                                const s = c.toLowerCase().trim();
                                return !s.includes('line') && c !== originalDuration && parseDurationToMinutes(c) === 0;
                            });
                            if (potentialReasons.length > 0) {
                                reason = potentialReasons.sort((a, b) => b.length - a.length)[0].trim();
                            }
                        }

                        if (colMap.startTime !== -1 && cols[colMap.startTime]) {
                            startTime = cols[colMap.startTime].trim();
                        }

                        try {
                            const d = new Date(dateVal);
                            if (!isNaN(d.getTime())) {
                                isoDate = d.toISOString().split('T')[0];
                            }
                        } catch (e) { isoDate = ''; }

                        if (colMap.side !== -1) side = cols[colMap.side];
                        if (colMap.eventCode !== -1) eventCode = cols[colMap.eventCode];
                        if (colMap.packages !== -1) packages = cols[colMap.packages];
                        if (colMap.otherCode !== -1) otherCode = cols[colMap.otherCode];
                        if (colMap.origEventCode !== -1) origEventCode = cols[colMap.origEventCode];
                        if (colMap.origEventDesc !== -1) origEventDesc = cols[colMap.origEventDesc];
                        if (colMap.infoEvents !== -1) infoEvents = cols[colMap.infoEvents];

                        const uniqueId = Date.now() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);

                        parsed.push({ 
                            id: uniqueId, 
                            line, 
                            duration, 
                            reason, 
                            date: dateVal, 
                            isoDate,
                            originalDuration,
                            startTime,
                            side,
                            eventCode,
                            packages,
                            otherCode,
                            origEventCode,
                            origEventDesc,
                            infoEvents
                        });
                    });

                    if (parsed.length === 0) {
                        setError("Could not identify any valid data rows. Please check format.");
                        return;
                    }

                    setProcessedData(prev => {
                        const current = prev || [];
                        return [...current, ...parsed];
                    });

                    setSuccessMsg(`Successfully added ${parsed.length} records.`);
                    setRawData('');
                    
                    const foundLines = [...new Set(parsed.map(p => p.line))].sort();
                    if (foundLines.length > 0) setActiveTab(foundLines[0]);

                    setTimeout(() => setSuccessMsg(null), 3000);

                } catch (err) {
                    setError("Error processing data.");
                    console.error(err);
                }
            };

            const loadSample = () => {
                setRawData(SAMPLE_DATA);
            };

            const clearDatabase = () => {
                if (window.confirm("Are you sure you want to delete all historical data?")) {
                    setProcessedData([]);
                    setRawData('');
                    localStorage.removeItem('downtimeDB');
                }
            };

            // --- MEMOIZED DATA ---

            const filteredData = useMemo(() => {
                return processedData.filter(d => {
                    if (d.line !== activeTab) return false;
                    if (searchTerm) {
                        const term = searchTerm.toLowerCase();
                        const match = d.reason.toLowerCase().includes(term) || 
                                    (d.eventCode && d.eventCode.toString().toLowerCase().includes(term)) ||
                                    (d.date && d.date.includes(term));
                        if (!match) return false;
                    }
                    if (startDate && d.isoDate < startDate) return false;
                    if (endDate && d.isoDate > endDate) return false;
                    
                    // NEW: Interactive Chart Filter
                    if (selectedMonth) {
                        if (!d.isoDate.startsWith(selectedMonth)) return false;
                    }

                    return true;
                });
            }, [processedData, activeTab, searchTerm, startDate, endDate, selectedMonth]);

            const chartData = useMemo(() => {
                const grouped = filteredData.reduce((acc, curr) => {
                    if (!acc[curr.reason]) acc[curr.reason] = 0;
                    acc[curr.reason] += curr.duration;
                    return acc;
                }, {});

                return Object.entries(grouped)
                    .map(([name, value]) => ({ 
                        name, 
                        minutes: parseFloat(value.toFixed(2)),
                        hours: parseFloat((value / 60).toFixed(2)) 
                    }))
                    .sort((a, b) => b.minutes - a.minutes);
            }, [filteredData]);

            const trendData = useMemo(() => {
                const dataToUse = processedData.filter(d => d.line === activeTab);
                
                const grouped = dataToUse.reduce((acc, curr) => {
                    if (!curr.isoDate) return acc;
                    const dateObj = new Date(curr.isoDate);
                    if (isNaN(dateObj)) return acc;
                    
                    const sortKey = curr.isoDate.slice(0, 7); // YYYY-MM
                    const displayKey = dateObj.toLocaleString('default', { month: 'short', year: '2-digit' });

                    if (!acc[sortKey]) {
                        acc[sortKey] = { name: displayKey, hours: 0, sortKey };
                    }
                    acc[sortKey].hours += curr.duration;
                    return acc;
                }, {});

                return Object.values(grouped)
                    .sort((a, b) => a.sortKey.localeCompare(b.sortKey))
                    .map(item => ({ ...item, hours: parseFloat((item.hours / 60).toFixed(2)) }));
            }, [processedData, activeTab]);

            const displayedChartData = useMemo(() => {
                if (topFilter === 'all') return chartData;
                return chartData.slice(0, parseInt(topFilter));
            }, [chartData, topFilter]);

            const totalDowntimeMinutes = chartData.reduce((acc, curr) => acc + curr.minutes, 0);
            const topIssue = chartData.length > 0 ? chartData[0].name : 'N/A';
            const activeColor = COLORS[activeTab] || COLORS['Line A'];

            const handleMonthClick = (data) => {
                if (data && data.activePayload && data.activePayload.length > 0) {
                    const clickedMonthKey = data.activePayload[0].payload.sortKey;
                    setSelectedMonth(prev => prev === clickedMonthKey ? null : clickedMonthKey);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 font-bold text-xl text-slate-900">
                                <BarChart2 className="text-blue-600" />
                                <span>Allentown PLMS Breakdown</span>
                                <span className="bg-slate-100 text-slate-500 text-xs px-2 py-0.5 rounded-full border border-slate-200">
                                    {processedData.length} Records
                                </span>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={clearDatabase} className="text-sm font-medium text-slate-400 hover:text-red-600 flex items-center gap-1 transition-colors">
                                    <Trash2 className="w-4 h-4" /> Clear DB
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Controls */}
                        <div className="mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div className="flex flex-col xl:flex-row gap-4 justify-between">
                                <div className="flex flex-wrap gap-2">
                                    {['Line A', 'Line B', 'Line C', 'Line D'].map((line) => {
                                        const c = COLORS[line];
                                        const isActive = activeTab === line;
                                        return (
                                            <button key={line} onClick={() => setActiveTab(line)} className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 shadow-sm ${isActive ? `${c.primary} text-white ring-2 ring-offset-1 ${c.ring}` : 'bg-slate-50 text-slate-500 hover:bg-slate-100 border border-slate-200'}`}>
                                                {line}
                                            </button>
                                        );
                                    })}
                                </div>
                                <div className="flex flex-wrap items-center gap-3">
                                    <div className="relative">
                                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                                        <input type="text" placeholder="Search Code, Reason..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-32 lg:w-48" />
                                    </div>
                                    <div className="h-6 w-px bg-slate-200 mx-1 hidden md:block"></div>
                                    <div className="flex items-center gap-2 bg-slate-50 p-1 rounded-lg border border-slate-200">
                                        <span className="text-xs font-medium text-slate-500 pl-2">From:</span>
                                        <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent text-sm border-none focus:ring-0 p-1 w-32 text-slate-700" />
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-50 p-1 rounded-lg border border-slate-200">
                                        <span className="text-xs font-medium text-slate-500 pl-2">To:</span>
                                        <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent text-sm border-none focus:ring-0 p-1 w-32 text-slate-700" />
                                    </div>
                                </div>
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-100">
                                <details className="group" open={processedData.length === 0}>
                                    <summary className="flex items-center gap-2 cursor-pointer text-sm font-medium text-blue-600 hover:text-blue-800">
                                        <Plus className="w-4 h-4" /> Import Data / Add More Records
                                    </summary>
                                    <div className="mt-3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <div className="mb-2 text-xs text-slate-500">
                                            <strong>Instructions:</strong> Paste Excel data with headers. Dates will automatically fill down if empty. 
                                        </div>
                                        <textarea value={rawData} onChange={(e) => setRawData(e.target.value)} placeholder="Paste Excel data here..." className="w-full h-32 p-3 border border-slate-300 rounded-lg font-mono text-xs bg-white focus:ring-2 focus:ring-blue-500 outline-none" />
                                        <div className="flex justify-between items-center mt-2">
                                            <div className="flex gap-2 items-center">
                                                <button onClick={handleProcess} className="bg-blue-600 text-white px-4 py-1.5 rounded-md text-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                                                    <CheckCircle className="w-4 h-4" /> Process & Add
                                                </button>
                                                <button onClick={loadSample} className="text-slate-500 hover:text-slate-700 px-3 py-1.5 text-sm transition-colors">
                                                    Load Sample
                                                </button>
                                            </div>
                                            <div className="flex gap-2 items-center">
                                                {successMsg && <span className="text-xs text-emerald-600 font-medium animate-pulse">{successMsg}</span>}
                                                {error && <span className="text-xs text-red-600 font-medium">{error}</span>}
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            {/* Left Column */}
                            <div className="col-span-1 space-y-6">
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <h3 className="text-slate-500 text-sm font-medium uppercase tracking-wider">Total Downtime</h3>
                                    <div className={`text-4xl font-bold mt-2 ${activeColor.text} transition-all duration-500`}>
                                        {(totalDowntimeMinutes / 60).toFixed(2)} <span className="text-lg text-slate-400 font-normal">Hours</span>
                                    </div>
                                    <div className="mt-4 text-sm text-slate-400 flex items-center gap-1">
                                        <Clock className="w-4 h-4" /> {totalDowntimeMinutes.toFixed(0)} Minutes
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <h3 className="text-slate-500 text-sm font-medium uppercase tracking-wider">Primary Issue</h3>
                                    <div className="text-2xl font-bold mt-2 text-slate-800 truncate transition-all duration-500" title={topIssue}>{topIssue}</div>
                                    <div className="mt-4 flex items-center gap-2">
                                        <div className={`h-2 w-full rounded-full bg-slate-100 overflow-hidden`}>
                                            <div className={`h-full ${activeColor.primary} transition-all duration-1000`} style={{ width: `${totalDowntimeMinutes > 0 ? (chartData.length > 0 ? (chartData[0].minutes / totalDowntimeMinutes) * 100 : 0) : 0}%` }} />
                                        </div>
                                        <span className="text-xs font-bold text-slate-500">{totalDowntimeMinutes > 0 && chartData.length > 0 ? Math.round((chartData[0].minutes / totalDowntimeMinutes) * 100) : 0}%</span>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-1">Percentage of total downtime</p>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-4 border-b border-slate-100 bg-slate-50 font-medium text-slate-700 flex justify-between items-center">
                                        <span>Issue Breakdown</span>
                                        <span className="text-xs text-slate-400 bg-white border px-2 py-0.5 rounded">
                                            {topFilter === 'all' ? 'All' : `Top ${topFilter}`}
                                        </span>
                                    </div>
                                    <div className="divide-y divide-slate-100 max-h-64 overflow-y-auto">
                                        {displayedChartData.map((item, idx) => (
                                            <div key={idx} className="p-4 flex justify-between items-center hover:bg-slate-50">
                                                <span className="text-sm text-slate-600 truncate pr-4 w-1/2" title={item.name}>{item.name}</span>
                                                <div className="text-right">
                                                    <span className="block text-sm font-bold text-slate-900">{item.hours.toFixed(1)}h</span>
                                                    <span className="block text-xs text-slate-500 font-medium">
                                                        {totalDowntimeMinutes > 0 ? ((item.minutes / totalDowntimeMinutes) * 100).toFixed(1) : 0}%
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                        {displayedChartData.length === 0 && <div className="p-6 text-center text-slate-400 text-sm">No data matches your filters.</div>}
                                    </div>
                                </div>
                            </div>

                            {/* Right Column (Charts) */}
                            <div className="col-span-1 lg:col-span-2 space-y-6">
                                
                                {/* Pareto Chart */}
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 h-[500px] flex flex-col">
                                    <div className="mb-6 flex justify-between items-end">
                                        <div>
                                            <h2 className="text-lg font-bold text-slate-900">Pareto Analysis (Hours)</h2>
                                            <p className="text-sm text-slate-500">
                                                {selectedMonth ? `Filtered: ${trendData.find(t => t.sortKey === selectedMonth)?.name}` : (startDate || endDate ? 'Filtered Date Range' : 'All Time')}
                                            </p>
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                                                {['5', '10', 'all'].map(val => (
                                                    <button
                                                        key={val}
                                                        onClick={() => setTopFilter(val)}
                                                        className={`
                                                            px-3 py-1 text-xs font-bold uppercase rounded-md transition-colors
                                                            ${topFilter === val ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400 hover:text-slate-600'}
                                                        `}
                                                    >
                                                        {val === 'all' ? 'All' : `Top ${val}`}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className={`px-3 py-1.5 rounded-full text-xs font-bold uppercase flex items-center ${activeColor.secondary} ${activeColor.text}`}>
                                                {activeTab}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 min-h-0">
                                        {displayedChartData.length > 0 ? (
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={displayedChartData} layout="vertical" margin={{ top: 5, right: 30, left: 60, bottom: 5 }}>
                                                    <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke="#e2e8f0" />
                                                    <XAxis type="number" stroke="#94a3b8" fontSize={12} />
                                                    <YAxis dataKey="name" type="category" width={140} tick={{fontSize: 11, fill: '#475569'}} />
                                                    <Tooltip 
                                                        cursor={{fill: 'transparent'}} 
                                                        contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} 
                                                        formatter={(value) => [`${value} hrs`, 'Duration']} 
                                                    />
                                                    <Bar 
                                                        dataKey="hours" 
                                                        fill={activeColor.hex} 
                                                        radius={[0, 4, 4, 0]} 
                                                        barSize={24} 
                                                        animationDuration={1200}
                                                        isAnimationActive={true}
                                                    />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                                <AlertCircle className="w-12 h-12 mb-2 opacity-20" />
                                                <p>No data found.</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Monthly Trend Chart Card */}
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-64 flex flex-col relative">
                                    <div className="mb-2 flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <TrendingUp className="w-4 h-4 text-slate-400" />
                                            <h3 className="text-sm font-bold text-slate-700">Monthly Trend</h3>
                                            <span className="text-xs text-slate-400 font-normal">(Click bar to filter dashboard)</span>
                                        </div>
                                        {selectedMonth && (
                                            <button 
                                                onClick={() => setSelectedMonth(null)}
                                                className="text-xs flex items-center gap-1 text-red-500 hover:bg-red-50 px-2 py-1 rounded transition-colors"
                                            >
                                                <XCircle className="w-3 h-3" /> Reset Filter
                                            </button>
                                        )}
                                    </div>
                                    <div className="flex-1 min-h-0">
                                        {trendData.length > 0 ? (
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart 
                                                    data={trendData} 
                                                    margin={{ top: 5, right: 5, left: -20, bottom: 0 }}
                                                    onClick={handleMonthClick}
                                                >
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="name" tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                                                    <YAxis tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                                                    <Tooltip 
                                                        cursor={{fill: '#f8fafc'}}
                                                        contentStyle={{ borderRadius: '6px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)', fontSize: '12px' }}
                                                        formatter={(value) => [`${value} hrs`, '']}
                                                    />
                                                    <Bar 
                                                        dataKey="hours" 
                                                        radius={[4, 4, 0, 0]}
                                                        animationDuration={1000}
                                                        isAnimationActive={true}
                                                        cursor="pointer"
                                                    >
                                                        {trendData.map((entry, index) => {
                                                            const isSelected = selectedMonth === entry.sortKey;
                                                            const isDimmed = selectedMonth && !isSelected;
                                                            
                                                            // If filtered, highlight the selected, dim others. If no filter, show all colorful.
                                                            let fillColor = MONTH_COLORS[index % MONTH_COLORS.length];
                                                            if (isDimmed) fillColor = '#e2e8f0'; 
                                                            
                                                            return (
                                                                <Cell 
                                                                    key={`cell-${index}`} 
                                                                    fill={fillColor} 
                                                                    opacity={isDimmed ? 0.6 : 1}
                                                                    stroke={isSelected ? '#1e293b' : 'none'}
                                                                    strokeWidth={isSelected ? 2 : 0}
                                                                />
                                                            );
                                                        })}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-xs text-slate-400">No trend data</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                                <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                                    <TableIcon className="w-4 h-4 text-slate-400" /> Database Entries
                                </h3>
                                <div className="text-xs text-slate-400">Showing {filteredData.length} of {processedData.length} total</div>
                            </div>
                            <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 z-10 shadow-sm">
                                        <tr className="bg-slate-50 text-slate-500 uppercase tracking-wider text-xs">
                                            <th className="px-6 py-3 font-medium bg-slate-50">Date</th>
                                            <th className="px-6 py-3 font-medium bg-slate-50">Start Time</th>
                                            <th className="px-6 py-3 font-medium bg-slate-50">Line</th>
                                            <th className="px-6 py-3 font-medium bg-slate-50">Code</th>
                                            <th className="px-6 py-3 font-medium bg-slate-50">Reason / Description</th>
                                            <th className="px-6 py-3 font-medium bg-slate-50 text-right">Packages</th>
                                            <th className="px-6 py-3 font-medium text-right bg-slate-50">Duration (Hrs)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredData.map((row) => (
                                            <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">
                                                    <div className="flex items-center gap-2">
                                                        {row.date}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 font-medium text-slate-600">{row.startTime}</td>
                                                <td className="px-6 py-4 font-medium text-slate-600">{row.line}</td>
                                                <td className="px-6 py-4 text-slate-600 font-mono text-xs">
                                                    {row.eventCode && (
                                                        <span className="bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">
                                                            {row.eventCode}
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-slate-600">
                                                    <div className="font-medium">{row.reason}</div>
                                                    {row.infoEvents && <div className="text-xs text-slate-400 mt-1">Info: {row.infoEvents}</div>}
                                                </td>
                                                <td className="px-6 py-4 text-right text-slate-600">{row.packages || '-'}</td>
                                                <td className="px-6 py-4 text-right font-mono text-slate-900 font-bold">
                                                    {(row.duration / 60).toFixed(2)}
                                                </td>
                                            </tr>
                                        ))}
                                        {filteredData.length === 0 && <tr><td colSpan="7" className="px-6 py-8 text-center text-slate-400 italic">No entries match current filters.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>